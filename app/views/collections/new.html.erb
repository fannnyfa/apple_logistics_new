<% content_for :page_title, "ìˆ˜ê±°ì ‘ìˆ˜ë“±ë¡" %>

<div class="p-6 max-w-2xl mx-auto">
  <!-- Header -->
  <div class="mb-6">
    <div class="space-y-1">
      <p class="text-slate-600">ìƒˆë¡œìš´ ìˆ˜ê±° ì ‘ìˆ˜ë¥¼ ë“±ë¡í•˜ì„¸ìš”</p>
    </div>
  </div>

  <!-- Form Card -->
  <%= render 'shared/components/card' do %>
    <%= render 'shared/components/form', title: nil do %>
      <%= form_with model: @collection, local: true, class: "space-y-6" do |form| %>
        <!-- Error Messages -->
        <% if @collection.errors.any? %>
          <%= render 'shared/components/alert', variant: 'destructive', title: 'ì…ë ¥ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' do %>
            <ul class="mt-2 text-sm list-disc list-inside">
              <% @collection.errors.full_messages.each do |message| %>
                <li><%= message %></li>
              <% end %>
            </ul>
          <% end %>
        <% end %>

        <!-- Fruit Category Selection -->
        <div class="space-y-2">
          <label class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">
            ê³¼ì¼ ì¢…ë¥˜ <span class="text-red-500">*</span>
          </label>
          <%= select_tag :fruit_category, 
              options_for_select([
                ["ì‚¬ê³¼", "apple"],
                ["ê¹»ì", "sesame"],
                ["ê°", "persimmon"]
              ], "apple"),
              { class: "flex h-10 w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm ring-offset-white file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-slate-500 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-slate-950 focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50", 
                id: "fruit_category_select",
                onchange: "handleFruitCategoryChange()" } %>
        </div>

        <!-- Farm Name Field -->
        <%= render 'shared/components/input', 
            field: form.text_field(:farm_name, placeholder: "ìƒì‚°ìëª…ì„ ì…ë ¥í•˜ì„¸ìš”"),
            label: "ìƒì‚°ì",
            required: true %>

        <!-- Product Name Field -->
        <div class="space-y-2">
          <label class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">
            í’ˆëª… <span class="text-red-500">*</span>
          </label>
          <!-- Single hidden field for product name -->
          <%= form.hidden_field :product_name, value: "ì‚¬ê³¼", id: "collection_product_name" %>
          
          <!-- Apple product field (shown by default) -->
          <div id="apple-product-field">
            <%= text_field_tag "product_display", "ì‚¬ê³¼",
                readonly: true,
                class: "flex h-10 w-full rounded-md border border-slate-300 bg-gray-50 px-3 py-2 text-sm ring-offset-white file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-slate-500 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-slate-950 focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50" %>
          </div>
          <!-- Sesame product field (hidden by default) -->
          <div id="sesame-product-field" style="display: none;">
            <%= select_tag "sesame_product_display", 
                options_for_select([
                  ["ê¹»ì", "ê¹»ì"],
                  ["ê¹»ì ë°”ë¼", "ê¹»ì ë°”ë¼"]
                ], "ê¹»ì"),
                { class: "flex h-10 w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm ring-offset-white file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-slate-500 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-slate-950 focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50", 
                  id: "sesame_product_select" } %>
          </div>
          <!-- Persimmon product field (hidden by default) -->
          <div id="persimmon-product-field" style="display: none;">
            <%= select_tag "persimmon_product_display", 
                options_for_select([
                  ["ë°˜ì‹œ", "ë°˜ì‹œ"],
                  ["ëŒ€ë´‰", "ëŒ€ë´‰"],
                  ["ë‹¨ê°", "ë‹¨ê°"]
                ], "ë°˜ì‹œ"),
                { class: "flex h-10 w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm ring-offset-white file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-slate-500 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-slate-950 focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50", 
                  id: "persimmon_product_select" } %>
          </div>
        </div>

        <!-- Quantity Field -->
        <%= render 'shared/components/input', 
            field: form.number_field(:quantity, placeholder: "ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”"),
            label: "ìˆ˜ëŸ‰",
            required: true %>

        <!-- Weight Selection -->
        <div class="space-y-2" id="weight_section">
          <label class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">
            ë¬´ê²Œ <span class="text-red-500">*</span>
          </label>
          <%= form.select :weight, 
              options_for_select([
                ["10kg", "10kg"],
                ["5kg", "5kg"]
              ], "10kg"),
              {},
              { class: "flex h-10 w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm ring-offset-white file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-slate-500 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-slate-950 focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50", 
                id: "weight_select" } %>
          <%= text_field_tag "weight_manual", "5kg",
              placeholder: "ë¬´ê²Œë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 5kg)",
              class: "flex h-10 w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm ring-offset-white file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-slate-500 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-slate-950 focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50", 
              id: "weight_input",
              style: "display: none;" %>
          <%= form.hidden_field :weight, id: "weight_hidden" %>
        </div>

        <!-- Market Selection -->
        <div class="space-y-2">
          <label class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">
            ê³µíŒì¥ <span class="text-red-500">*</span>
          </label>
          <%= form.select :market_id, 
              grouped_options_for_select(@markets.group_by(&:district).transform_values { |markets| 
                markets.map { |m| [m.name, m.id] }
              }, @collection.market_id),
              { prompt: "ê³µíŒì¥ì„ ì„ íƒí•˜ì„¸ìš”" },
              { class: "flex h-10 w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm ring-offset-white file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-slate-500 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-slate-950 focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50" } %>
        </div>

        <!-- Scheduled Date -->
        <%= render 'shared/components/input', 
            field: form.date_field(:scheduled_at, value: Date.today),
            label: "ì ‘ìˆ˜ ì¼ì",
            required: true %>

        <!-- Action Buttons -->
        <div class="flex flex-col sm:flex-row gap-3 pt-4">
          <%= form.submit "ì ‘ìˆ˜ ë“±ë¡", class: "inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors duration-200 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-slate-100 text-slate-900 hover:bg-slate-200 border border-slate-200 h-10 px-4 py-2 cursor-pointer" %>
          <%= link_to "ì·¨ì†Œ", collections_path, class: "inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors duration-200 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-slate-100 text-slate-900 hover:bg-slate-200 border border-slate-200 h-10 px-4 py-2" %>
          <!-- ìŒì„±ì…ë ¥ ë²„íŠ¼ -->
          <button type="button" 
                  id="voiceButton"
                  class="rounded-full bg-slate-100 text-slate-800 text-sm px-4 py-2 border border-slate-300 hover:bg-slate-200 ml-auto transition-all duration-200"
                  onclick="startVoiceInput()">
            ğŸ¤ ìŒì„±ì…ë ¥
          </button>
        </div>
      <% end %>
    <% end %>
  <% end %>
</div>

<script>
// Global function to handle weight field changes
function toggleWeightFieldByCategory() {
  const categorySelect = document.getElementById('fruit_category_select');
  const weightSection = document.getElementById('weight_section');
  const weightSelect = document.getElementById('weight_select');
  const weightInput = document.getElementById('weight_input');
  const weightHidden = document.getElementById('weight_hidden');
  
  if (!categorySelect || !weightSection || !weightSelect || !weightInput || !weightHidden) {
    console.log('Weight field elements not found');
    return;
  }
  
  const fruitCategory = categorySelect.value;
  const currentProductName = document.getElementById('collection_product_name').value;
  
  console.log('toggleWeightFieldByCategory - Category:', fruitCategory, 'Product:', currentProductName);
  
  if (fruitCategory === 'apple') {
    // ì‚¬ê³¼ ì„ íƒ ì‹œ ë¬´ê²Œ ì„¹ì…˜ê³¼ ë“œë¡­ë‹¤ìš´ í‘œì‹œ
    weightSection.style.display = 'block';
    weightSelect.style.display = 'block';
    weightInput.style.display = 'none';
    weightSelect.required = true;
    weightInput.required = false;
    weightHidden.value = weightSelect.value;
    console.log('Apple selected - showing weight section and dropdown');
  } else if (fruitCategory === 'persimmon') {
    // ê° ì„ íƒ ì‹œ ë¬´ê²Œ ì„¹ì…˜ê³¼ ë“œë¡­ë‹¤ìš´ í‘œì‹œ (ê¸°ë³¸ê°’: 5kg)
    weightSection.style.display = 'block';
    weightSelect.style.display = 'block';
    weightInput.style.display = 'none';
    weightSelect.required = true;
    weightInput.required = false;
    weightSelect.value = '5kg'; // ê° ê¸°ë³¸ê°’ ì„¤ì •
    weightHidden.value = weightSelect.value;
    console.log('Persimmon selected - showing weight section and dropdown with 5kg default');
  } else if (fruitCategory === 'sesame') {
    if (currentProductName === 'ê¹»ì ë°”ë¼') {
      // ê¹»ì ë°”ë¼ ì„ íƒ ì‹œ ë¬´ê²Œ ì„¹ì…˜ê³¼ ìˆ˜ë™ ì…ë ¥ í•„ë“œ í‘œì‹œ
      weightSection.style.display = 'block';
      weightSelect.style.display = 'none';
      weightInput.style.display = 'block';
      weightInput.required = true;
      weightSelect.required = false;
      weightHidden.value = weightInput.value;
      console.log('Sesame bara selected - showing weight section and input');
    } else if (currentProductName === 'ê¹»ì') {
      // ê¹»ì ì„ íƒ ì‹œ ë¬´ê²Œ ì„¹ì…˜ ì „ì²´ ìˆ¨ê¹€
      weightSection.style.display = 'none';
      weightSelect.required = false;
      weightInput.required = false;
      weightHidden.value = '';
      console.log('Sesame selected - hiding entire weight section');
    }
  }
}

// Handle fruit category dropdown change
function handleFruitCategoryChange() {
  const categorySelect = document.getElementById('fruit_category_select');
  const selectedCategory = categorySelect.value;
  
  console.log('Selected fruit category:', selectedCategory);
  
  // Update product fields based on selection
  const appleProductField = document.getElementById('apple-product-field');
  const sesameProductField = document.getElementById('sesame-product-field');
  const persimmonProductField = document.getElementById('persimmon-product-field');
  
  // Hide all product fields first
  appleProductField.style.display = 'none';
  sesameProductField.style.display = 'none';
  persimmonProductField.style.display = 'none';
  
  if (selectedCategory === 'apple') {
    appleProductField.style.display = 'block';
    // Set product name to ì‚¬ê³¼
    document.getElementById('collection_product_name').value = 'ì‚¬ê³¼';
  } else if (selectedCategory === 'sesame') {
    sesameProductField.style.display = 'block';
    // Set product name to first sesame option
    const sesameSelect = document.getElementById('sesame_product_select');
    if (sesameSelect) {
      document.getElementById('collection_product_name').value = sesameSelect.value;
    }
  } else if (selectedCategory === 'persimmon') {
    persimmonProductField.style.display = 'block';
    // Set product name to first persimmon option (ê¸°ë³¸ê°’: ë°˜ì‹œ)
    const persimmonSelect = document.getElementById('persimmon_product_select');
    if (persimmonSelect) {
      document.getElementById('collection_product_name').value = persimmonSelect.value;
    }
  }
  
  // Update weight field based on category
  toggleWeightFieldByCategory();
}

// Legacy function for backward compatibility (used by voice recognition)
function selectFruitCategory(category) {
  const categorySelect = document.getElementById('fruit_category_select');
  categorySelect.value = category;
  handleFruitCategoryChange();
}

// ì œí’ˆ ì„ íƒì— ë”°ë¥¸ ë¬´ê²Œ í•„ë“œ ë³€ê²½
document.addEventListener('DOMContentLoaded', function() {
  const weightSelect = document.getElementById('weight_select');
  const weightInput = document.getElementById('weight_input');
  const weightHidden = document.getElementById('weight_hidden');
  
  // Sesame product selection change handler
  const sesameProductSelect = document.getElementById('sesame_product_select');
  if (sesameProductSelect) {
    sesameProductSelect.addEventListener('change', function() {
      document.getElementById('collection_product_name').value = this.value;
      toggleWeightFieldByCategory();
    });
  }
  
  // Persimmon product selection change handler
  const persimmonProductSelect = document.getElementById('persimmon_product_select');
  if (persimmonProductSelect) {
    persimmonProductSelect.addEventListener('change', function() {
      document.getElementById('collection_product_name').value = this.value;
      toggleWeightFieldByCategory();
    });
  }
  
  // Legacy function for backward compatibility
  function toggleWeightField() {
    toggleWeightFieldByCategory();
  }
  
  // ë¬´ê²Œ ê°’ ë³€ê²½ ì‹œ ìˆ¨ê²¨ì§„ í•„ë“œ ì—…ë°ì´íŠ¸
  weightSelect.addEventListener('change', function() {
    weightHidden.value = weightSelect.value;
  });
  
  weightInput.addEventListener('input', function() {
    weightHidden.value = weightInput.value;
  });
  
  // ì´ˆê¸° ìƒíƒœ ì„¤ì •
  setTimeout(function() {
    toggleWeightFieldByCategory();
  }, 100);
});

// ë²„íŠ¼ ìƒíƒœ ë³€ê²½ í•¨ìˆ˜ë“¤
function setVoiceButtonListening() {
  const button = document.getElementById('voiceButton');
  if (button) {
    button.textContent = 'ğŸ”´ ì¸ì‹ì¤‘...';
    button.className = 'rounded-full bg-red-500 text-black text-sm px-4 py-2 border border-red-600 ml-auto transition-all duration-200 animate-pulse';
    button.disabled = true;
    console.log("ğŸ”´ ë²„íŠ¼ ìƒíƒœ: ì¸ì‹ì¤‘ìœ¼ë¡œ ë³€ê²½");
  }
}

function setVoiceButtonDefault() {
  const button = document.getElementById('voiceButton');
  if (button) {
    button.textContent = 'ğŸ¤ ìŒì„±ì…ë ¥';
    button.className = 'rounded-full bg-slate-100 text-slate-800 text-sm px-4 py-2 border border-slate-300 hover:bg-slate-200 ml-auto transition-all duration-200';
    button.disabled = false;
    console.log("ğŸ¤ ë²„íŠ¼ ìƒíƒœ: ê¸°ë³¸ìœ¼ë¡œ ë³µêµ¬");
  }
}

function startVoiceInput() {
  console.log("ğŸ¤ ìŒì„±ì…ë ¥ ë²„íŠ¼ í´ë¦­ë¨");
  
  // ë¸Œë¼ìš°ì €ì˜ Web Speech API ì§€ì› ì—¬ë¶€ í™•ì¸
  const Recognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  
  if (!Recognition) {
    console.log("âŒ ìŒì„± ì¸ì‹ ë¯¸ì§€ì› ë¸Œë¼ìš°ì €");
    alert("ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤");
    return;
  }
  
  console.log("âœ… ìŒì„± ì¸ì‹ API ì‚¬ìš© ê°€ëŠ¥");
  
  // ìŒì„± ì¸ì‹ ê°ì²´ ìƒì„± ë° ì„¤ì •
  const recognition = new Recognition();
  recognition.lang = 'ko-KR';  // í•œêµ­ì–´ë¡œ ì„¤ì •
  recognition.interimResults = true;  // ì¤‘ê°„ ê²°ê³¼ë„ ë°›ê¸° (ë” ë°˜ì‘ì„± í–¥ìƒ)
  recognition.continuous = true;  // ì—°ì† ì¸ì‹ ëª¨ë“œ
  recognition.maxAlternatives = 1;  // ìµœìƒìœ„ ê²°ê³¼ë§Œ ë°›ê¸°
  
  // ìŒì„± ì¸ì‹ ì‹œê°„ ì œí•œ ì„¤ì • (20ì´ˆë¡œ ì—°ì¥)
  let speechTimeout = setTimeout(() => {
    console.log("â° ìŒì„± ì¸ì‹ ì‹œê°„ ì´ˆê³¼");
    recognition.stop();
    setVoiceButtonDefault(); // íƒ€ì„ì•„ì›ƒ ì‹œì—ë„ ë²„íŠ¼ ìƒíƒœ ë³µêµ¬
    alert("ìŒì„± ì¸ì‹ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
  }, 20000);
  
  // ìŒì„± ì¤‘ë‹¨ í›„ ìë™ ì¢…ë£Œë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•œ íƒ€ì´ë¨¸
  let silenceTimer = null;
  
  // ìŒì„± ì¸ì‹ ì‹œì‘ ì´ë²¤íŠ¸
  recognition.onstart = () => {
    console.log("ğŸ™ï¸ ìŒì„± ì¸ì‹ ì‹œì‘ë¨ - ë§ì”€í•´ ì£¼ì„¸ìš”!");
    setVoiceButtonListening(); // ë²„íŠ¼ ìƒíƒœë¥¼ ì¸ì‹ì¤‘ìœ¼ë¡œ ë³€ê²½
  };
  
  // ìŒì„± ì¸ì‹ ê²°ê³¼ ì²˜ë¦¬
  recognition.onresult = (event) => {
    // ì¤‘ê°„ ê²°ê³¼ì™€ ìµœì¢… ê²°ê³¼ êµ¬ë¶„
    for (let i = event.resultIndex; i < event.results.length; i++) {
      const result = event.results[i];
      const transcript = result[0].transcript;
      
      if (result.isFinal) {
        // ìµœì¢… ê²°ê³¼ì¼ ë•Œë§Œ í•„ë“œ ì…ë ¥
        console.log("ğŸ“ ìµœì¢… ì¸ì‹ëœ í…ìŠ¤íŠ¸:", transcript);
        clearTimeout(speechTimeout);  // íƒ€ì„ì•„ì›ƒ í´ë¦¬ì–´
        clearTimeout(silenceTimer);   // ì¹¨ë¬µ íƒ€ì´ë¨¸ í´ë¦¬ì–´
        
        // ì¸ì‹ëœ í…ìŠ¤íŠ¸ë¥¼ ê° ì…ë ¥ í•„ë“œì— ìë™ ì…ë ¥
        fillFormFields(transcript);
        
        // ìŒì„± ì¸ì‹ ì¢…ë£Œ (ìµœì¢… ê²°ê³¼ë¥¼ ë°›ì•˜ìœ¼ë¯€ë¡œ)
        recognition.stop();
        setVoiceButtonDefault(); // ë²„íŠ¼ ìƒíƒœë¥¼ ê¸°ë³¸ìœ¼ë¡œ ë³µêµ¬
        return;
      } else {
        // ì¤‘ê°„ ê²°ê³¼ (ì‚¬ìš©ìê°€ ë§í•˜ê³  ìˆëŠ” ì¤‘)
        console.log("ğŸ”„ ì¤‘ê°„ ì¸ì‹ ê²°ê³¼:", transcript);
        
        // ì¹¨ë¬µ íƒ€ì´ë¨¸ ì´ˆê¸°í™” (ê³„ì† ë§í•˜ê³  ìˆìœ¼ë¯€ë¡œ)
        clearTimeout(silenceTimer);
        silenceTimer = setTimeout(() => {
          console.log("ğŸ¤« ì¹¨ë¬µ ê°ì§€, ìŒì„± ì¸ì‹ ì¢…ë£Œ");
          recognition.stop();
          setVoiceButtonDefault(); // ë²„íŠ¼ ìƒíƒœë¥¼ ê¸°ë³¸ìœ¼ë¡œ ë³µêµ¬
        }, 3000); // 3ì´ˆ ì¹¨ë¬µ í›„ ì¢…ë£Œ
      }
    }
  };
  
  // ìŒì„± ì¸ì‹ ì¢…ë£Œ ì´ë²¤íŠ¸ (ìë™ ì¢…ë£Œ ë°©ì§€)
  recognition.onspeechend = () => {
    console.log("ğŸ”‡ ìŒì„± ê°ì§€ ì¢…ë£Œë¨ - í•˜ì§€ë§Œ ê³„ì† ëŒ€ê¸° ì¤‘...");
    // ë°”ë¡œ ì¢…ë£Œí•˜ì§€ ì•Šê³  ì¹¨ë¬µ íƒ€ì´ë¨¸ë¡œ ê´€ë¦¬
  };
  
  // ìŒì„± ì¸ì‹ ì™„ì „ ì¢…ë£Œ ì´ë²¤íŠ¸
  recognition.onend = () => {
    console.log("ğŸ ìŒì„± ì¸ì‹ ì™„ì „ ì¢…ë£Œë¨");
    clearTimeout(speechTimeout);  // íƒ€ì„ì•„ì›ƒ í´ë¦¬ì–´
    clearTimeout(silenceTimer);   // ì¹¨ë¬µ íƒ€ì´ë¨¸ í´ë¦¬ì–´
    setVoiceButtonDefault(); // ë²„íŠ¼ ìƒíƒœë¥¼ ê¸°ë³¸ìœ¼ë¡œ ë³µêµ¬
  };
  
  // ìŒì„± ì¸ì‹ ì—ëŸ¬ ì²˜ë¦¬
  recognition.onerror = (event) => {
    clearTimeout(speechTimeout);  // íƒ€ì„ì•„ì›ƒ í´ë¦¬ì–´
    clearTimeout(silenceTimer);   // ì¹¨ë¬µ íƒ€ì´ë¨¸ í´ë¦¬ì–´
    console.error("âŒ ìŒì„± ì¸ì‹ ì˜¤ë¥˜:", event.error);
    
    let errorMessage = "ìŒì„± ì¸ì‹ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤";
    switch(event.error) {
      case 'no-speech':
        errorMessage = "ìŒì„±ì´ ê°ì§€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë§ˆì´í¬ë¥¼ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”";
        break;
      case 'audio-capture':
        errorMessage = "ë§ˆì´í¬ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ê¶Œí•œì„ í™•ì¸í•´ ì£¼ì„¸ìš”";
        break;
      case 'not-allowed':
        errorMessage = "ë§ˆì´í¬ ì‚¬ìš© ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ë§ˆì´í¬ ê¶Œí•œì„ í—ˆìš©í•´ ì£¼ì„¸ìš”";
        break;
      case 'network':
        errorMessage = "ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ ì£¼ì„¸ìš”";
        break;
      case 'aborted':
        errorMessage = "ìŒì„± ì¸ì‹ì´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤";
        break;
    }
    
    alert(errorMessage);
    setVoiceButtonDefault(); // ì—ëŸ¬ ë°œìƒ ì‹œì—ë„ ë²„íŠ¼ ìƒíƒœë¥¼ ê¸°ë³¸ìœ¼ë¡œ ë³µêµ¬
  };
  
  // ìŒì„± ì¸ì‹ ì‹œì‘
  try {
    recognition.start();
    console.log("ğŸš€ ìŒì„± ì¸ì‹ ì‹œì‘ ì‹œë„...");
  } catch (error) {
    console.error("âŒ ìŒì„± ì¸ì‹ ì‹œì‘ ì‹¤íŒ¨:", error);
    setVoiceButtonDefault(); // ì‹œì‘ ì‹¤íŒ¨ ì‹œì—ë„ ë²„íŠ¼ ìƒíƒœ ë³µêµ¬
    alert("ìŒì„± ì¸ì‹ì„ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
  }
}

// ì¸ì‹ëœ í…ìŠ¤íŠ¸ë¥¼ ë¶„ì„í•˜ì—¬ ê° ì…ë ¥ í•„ë“œì— ìë™ ì…ë ¥
function fillFormFields(transcript) {
  console.log("ğŸ“‹ í•„ë“œ ìë™ ì…ë ¥ ì‹œì‘:", transcript);
  
  // í…ìŠ¤íŠ¸ë¥¼ ê³µë°±ìœ¼ë¡œ ë¶„ë¦¬í•˜ì—¬ ê° ë‹¨ì–´ ë¶„ì„
  const words = transcript.trim().split(/\s+/);
  console.log("ğŸ”¤ ë¶„ì„í•  ë‹¨ì–´ë“¤:", words);
  
  // 1. ìƒì‚°ì ì´ë¦„ ì¶”ì¶œ (ì²« ë²ˆì§¸ í•œê¸€ ì´ë¦„ìœ¼ë¡œ ì¶”ì •ë˜ëŠ” ë¶€ë¶„)
  const farmNameField = document.getElementById('collection_farm_name');
  if (farmNameField && words.length > 0) {
    // ì²« ë²ˆì§¸ ë‹¨ì–´ê°€ í•œê¸€ì´ê³  ìˆ«ìê°€ ì•„ë‹Œ ê²½ìš° ìƒì‚°ì ì´ë¦„ìœ¼ë¡œ íŒë‹¨
    const firstWord = words[0];
    if (/^[ê°€-í£]+$/.test(firstWord) && !/\d/.test(firstWord)) {
      farmNameField.value = firstWord;
      console.log("ğŸ‘¤ ìƒì‚°ì ì´ë¦„ ì„¤ì •:", firstWord);
    }
  }
  
  // 2. ê³¼ì¼ ì¢…ë¥˜ ë° í’ˆëª… ì„¤ì •
  let selectedCategory = 'apple'; // ê¸°ë³¸ê°’
  let selectedProduct = 'ì‚¬ê³¼'; // ê¸°ë³¸ê°’
  
  if (transcript.includes('ê¹»ìë°”ë¼') || transcript.includes('ê¹»ì ë°”ë¼')) {
    selectedCategory = 'sesame';
    selectedProduct = 'ê¹»ì ë°”ë¼';
  } else if (transcript.includes('ê¹»ì')) {
    selectedCategory = 'sesame';
    selectedProduct = 'ê¹»ì';
  } else if (transcript.includes('ë°˜ì‹œ')) {
    selectedCategory = 'persimmon';
    selectedProduct = 'ë°˜ì‹œ';
  } else if (transcript.includes('ëŒ€ë´‰')) {
    selectedCategory = 'persimmon';
    selectedProduct = 'ëŒ€ë´‰';
  } else if (transcript.includes('ë‹¨ê°')) {
    selectedCategory = 'persimmon';
    selectedProduct = 'ë‹¨ê°';
  } else if (transcript.includes('ê°')) {
    selectedCategory = 'persimmon';
    selectedProduct = 'ë°˜ì‹œ'; // ê° ê¸°ë³¸ê°’
  }
  
  // ê³¼ì¼ ë¶„ë¥˜ ì„ íƒ
  selectFruitCategory(selectedCategory);
  
  // í’ˆëª… ì„¤ì •
  const productNameField = document.getElementById('collection_product_name');
  if (productNameField) {
    productNameField.value = selectedProduct;
    console.log("ğŸŒ¿ ê³¼ì¼ ë¶„ë¥˜:", selectedCategory, "í’ˆëª… ì„¤ì •:", selectedProduct);
    
    // ê¹»ìì¸ ê²½ìš° select ì˜µì…˜ë„ ì—…ë°ì´íŠ¸
    if (selectedCategory === 'sesame') {
      const sesameSelect = document.getElementById('sesame_product_select');
      if (sesameSelect) {
        sesameSelect.value = selectedProduct;
      }
    }
    // ê°ì¸ ê²½ìš° select ì˜µì…˜ë„ ì—…ë°ì´íŠ¸
    else if (selectedCategory === 'persimmon') {
      const persimmonSelect = document.getElementById('persimmon_product_select');
      if (persimmonSelect) {
        persimmonSelect.value = selectedProduct;
      }
    }
  }
  
  // 3. ìˆ˜ëŸ‰ ì¶”ì¶œ (ë‹¨ì–´ë“¤ ì¤‘ì—ì„œ ìˆ«ì ì°¾ê¸°)
  const quantityField = document.getElementById('collection_quantity');
  if (quantityField) {
    // ìˆ«ìê°€ í¬í•¨ëœ ë‹¨ì–´ ì°¾ê¸° (ì˜ˆ: "5ê°œ", "10", "ë‹¤ì„¯ê°œ" ë“±)
    let quantity = null;
    
    for (let word of words) {
      // ìˆœìˆ˜ ìˆ«ìì¸ ê²½ìš°
      if (/^\d+$/.test(word)) {
        quantity = word;
        break;
      }
      // ìˆ«ì+ê°œ í˜•íƒœì¸ ê²½ìš°
      const numberMatch = word.match(/^(\d+)ê°œ?$/);
      if (numberMatch) {
        quantity = numberMatch[1];
        break;
      }
    }
    
    // í•œê¸€ ìˆ«ìë„ ì²˜ë¦¬
    if (!quantity) {
      const koreanNumbers = {
        'í•˜ë‚˜': '1', 'í•œê°œ': '1', 'ì¼': '1',
        'ë‘˜': '2', 'ë‘ê°œ': '2', 'ì´': '2',
        'ì…‹': '3', 'ì„¸ê°œ': '3', 'ì‚¼': '3',
        'ë„·': '4', 'ë„¤ê°œ': '4', 'ì‚¬': '4',
        'ë‹¤ì„¯': '5', 'ë‹¤ì„¯ê°œ': '5', 'ì˜¤': '5',
        'ì—¬ì„¯': '6', 'ì—¬ì„¯ê°œ': '6', 'ìœ¡': '6',
        'ì¼ê³±': '7', 'ì¼ê³±ê°œ': '7', 'ì¹ ': '7',
        'ì—¬ëŸ': '8', 'ì—¬ëŸê°œ': '8', 'íŒ”': '8',
        'ì•„í™‰': '9', 'ì•„í™‰ê°œ': '9', 'êµ¬': '9',
        'ì—´': '10', 'ì—´ê°œ': '10', 'ì‹­': '10'
      };
      
      for (let word of words) {
        if (koreanNumbers[word]) {
          quantity = koreanNumbers[word];
          break;
        }
      }
    }
    
    if (quantity) {
      quantityField.value = quantity;
      console.log("ğŸ”¢ ìˆ˜ëŸ‰ ì„¤ì •:", quantity);
    }
  }
  
  // 4. ë¬´ê²Œ ì„¤ì • (5í‚¬ë¡œ ì–¸ê¸‰ ì‹œ 5kg, ì•„ë‹ˆë©´ 10kg)
  const weightField = document.getElementById('collection_weight');
  if (weightField) {
    // ë” ì •í™•í•œ 5kg íŒë³„: ë‹¨ë… "5", "ë‹¤ì„¯", "ì˜¤í‚¬ë¡œ", "5í‚¬ë¡œ", "5kg" ë“±ë§Œ ë§¤ì¹­
    const hasFiveKg = /\b5\b|ë‹¤ì„¯|ì˜¤í‚¬ë¡œ|ë‹¤ì„¯í‚¬ë¡œ|5í‚¬ë¡œ|5kg|ì˜¤\s*í‚¬ë¡œ|ë‹¤ì„¯\s*í‚¬ë¡œ/.test(transcript);
    
    // "ì˜¤ì‹­", "ì˜¤ì‹­ì¼" ë“±ì€ ì œì™¸í•˜ê³  ì •í™•í•œ 5kg í‘œí˜„ë§Œ ë§¤ì¹­
    const isNotFifty = !/ì˜¤ì‹­|ì˜¤ì‹­ì¼|ì˜¤ì‹­ì´|ì˜¤ì‹­ì‚¼|ì˜¤ì‹­ì‚¬|ì˜¤ì‹­ì˜¤|ì˜¤ì‹­ìœ¡|ì˜¤ì‹­ì¹ |ì˜¤ì‹­íŒ”|ì˜¤ì‹­êµ¬/.test(transcript);
    
    const selectedWeight = (hasFiveKg && isNotFifty) ? '5kg' : '10kg';
    weightField.value = selectedWeight;
    console.log("âš–ï¸ ë¬´ê²Œ ì„¤ì •:", selectedWeight, "(5kg íŒë³„:", hasFiveKg, ", ì˜¤ì‹­ ì œì™¸:", isNotFifty, ")");
  }
  
  // 5. ê³µíŒì¥ ìë™ ì„ íƒ (ë‹¨ì–´ ë‹¨ìœ„ë¡œ ë§¤í•‘ ê²€ì‚¬)
  const marketField = document.getElementById('collection_market_id');
  if (marketField) {
    const options = Array.from(marketField.options);
    console.log("ğŸª ê³µíŒì¥ ì˜µì…˜ ê²€ì‚¬ ì¤‘...", options.length + "ê°œ");
    console.log("ğŸ¤ ì „ì²´ ìŒì„±ì¸ì‹ í…ìŠ¤íŠ¸:", transcript);
    console.log("ğŸ“‹ ì‚¬ìš© ê°€ëŠ¥í•œ ê³µíŒì¥ ì˜µì…˜ë“¤:", options.map(o => o.text));
    
    // ê³µíŒì¥ ë§¤í•‘ (ì¤„ì„ë§ê³¼ ì „ì²´ ëª…ì¹­ ëª¨ë‘ í¬í•¨)
    const marketMappings = {
      // ì—„ê¶ë†í˜‘ê³µíŒì¥ ë§¤í•‘
      "ë¶€ê³µ": "ì—„ê¶ë†í˜‘ê³µíŒì¥",
      "ì—„ê¶ë†í˜‘ê³µíŒì¥": "ì—„ê¶ë†í˜‘ê³µíŒì¥",
      "ì—„ê¶ë†í˜‘": "ì—„ê¶ë†í˜‘ê³µíŒì¥",
      "ì—„ê¶": "ì—„ê¶ë†í˜‘ê³µíŒì¥",
      
      // í•­ë„ì²­ê³¼ ë§¤í•‘
      "í•­ë„": "í•­ë„ì²­ê³¼",
      "í•­ë„ì²­ê³¼": "í•­ë„ì²­ê³¼",
      
      // ë¶€ì‚°ì²­ê³¼ ë§¤í•‘
      "ë¶€ì²­": "ë¶€ì‚°ì²­ê³¼",
      "ë¶€ì‚°ì²­ê³¼": "ë¶€ì‚°ì²­ê³¼",
      "ë¶€ì‚°": "ë¶€ì‚°ì²­ê³¼",
      
      // ë°˜ì—¬ë†í˜‘ê³µíŒì¥ ë§¤í•‘
      "ë°˜ë†": "ë°˜ì—¬ë†í˜‘ê³µíŒì¥",
      "ë°˜ì—¬ë†í˜‘ê³µíŒì¥": "ë°˜ì—¬ë†í˜‘ê³µíŒì¥",
      "ë°˜ì—¬ë†í˜‘": "ë°˜ì—¬ë†í˜‘ê³µíŒì¥",
      "ë°˜ì—¬": "ë°˜ì—¬ë†í˜‘ê³µíŒì¥",
      
      // ì¤‘ì•™ì²­ê³¼ ë§¤í•‘
      "ì¤‘ì•™": "ì¤‘ì•™ì²­ê³¼",
      "ì¤‘ì•™ì²­ê³¼": "ì¤‘ì•™ì²­ê³¼",
      
      // ë™ë¶€ì²­ê³¼ ë§¤í•‘
      "ë™ë¶€": "ë™ë¶€ì²­ê³¼",
      "ë™ë¶€ì²­ê³¼": "ë™ë¶€ì²­ê³¼",
      
      // ì¶”ê°€ ê°€ëŠ¥í•œ ë§¤í•‘ (í•„ìš”ì‹œ)
      "ê°€ë½": "ì„œìš¸ê°€ë½ê³µíŒì¥",
      "ì„œìš¸ê°€ë½ê³µíŒì¥": "ì„œìš¸ê°€ë½ê³µíŒì¥",
      "ì„œìš¸": "ì„œìš¸ê°€ë½ê³µíŒì¥"
    };
    
    let selectedMarket = null;
    
    // 1ë‹¨ê³„: ì „ì²´ í…ìŠ¤íŠ¸ì—ì„œ ì§ì ‘ í‚¤ì›Œë“œ ê²€ì‚¬ (ìš°ì„ ìˆœìœ„)
    const directMappings = {
      "ë°˜ë†": "ë°˜ì—¬ë†í˜‘ê³µíŒì¥",
      "ë°˜ì—¬": "ë°˜ì—¬ë†í˜‘ê³µíŒì¥",
      "ë°˜ì—¬ë†í˜‘": "ë°˜ì—¬ë†í˜‘ê³µíŒì¥",
      "ë°˜ì—¬ë†ê³µ": "ë°˜ì—¬ë†í˜‘ê³µíŒì¥",
      "ë°˜ì—¬ë†í˜‘ê³µíŒì¥": "ë°˜ì—¬ë†í˜‘ê³µíŒì¥",
      "ë¶€ê³µ": "ì—„ê¶ë†í˜‘ê³µíŒì¥", 
      "ì—„ê¶": "ì—„ê¶ë†í˜‘ê³µíŒì¥",
      "ì—„ê¶ë†í˜‘": "ì—„ê¶ë†í˜‘ê³µíŒì¥",
      "ì—„ê¶ë†ê³µ": "ì—„ê¶ë†í˜‘ê³µíŒì¥",
      "ë¶€ì²­": "ë¶€ì‚°ì²­ê³¼",
      "ë¶€ì‚°ì²­ê³¼": "ë¶€ì‚°ì²­ê³¼",
      "í•­ë„": "í•­ë„ì²­ê³¼",
      "í•­ë„ì²­ê³¼": "í•­ë„ì²­ê³¼",
      "ì¤‘ì•™": "ì¤‘ì•™ì²­ê³¼",
      "ì¤‘ì•™ì²­ê³¼": "ì¤‘ì•™ì²­ê³¼",
      "ë™ë¶€": "ë™ë¶€ì²­ê³¼",
      "ë™ë¶€ì²­ê³¼": "ë™ë¶€ì²­ê³¼"
    };
    
    // ì§ì ‘ ë§¤í•‘ ë¨¼ì € í™•ì¸ (ë” ìœ ì—°í•œ ë§¤ì¹­)
    for (let [keyword, targetName] of Object.entries(directMappings)) {
      console.log("ğŸ” í‚¤ì›Œë“œ ê²€ì‚¬:", keyword, "í…ìŠ¤íŠ¸ì— í¬í•¨?", transcript.includes(keyword));
      
      if (transcript.includes(keyword)) {
        console.log("ğŸ¯ í‚¤ì›Œë“œ ë°œê²¬:", keyword, "â†’ ëŒ€ìƒ:", targetName);
        
        const matchedOption = options.find(option => {
          if (!option.text || option.text === 'ê³µíŒì¥ì„ ì„ íƒí•˜ì„¸ìš”') return false;
          console.log("ğŸ” ì˜µì…˜ ë¹„êµ:", option.text, "vs", targetName);
          return option.text.includes(targetName) || targetName.includes(option.text);
        });
        
        console.log("ğŸª ë§¤ì¹­ëœ ì˜µì…˜:", matchedOption ? matchedOption.text : "ì—†ìŒ");
        
        if (matchedOption) {
          selectedMarket = matchedOption;
          console.log("âœ… ì§ì ‘ ë§¤í•‘ ì„±ê³µ:", keyword, "â†’", targetName, "ì„ íƒëœ ì˜µì…˜:", matchedOption.text);
          break;
        } else {
          console.log("âŒ ì˜µì…˜ ë§¤ì¹­ ì‹¤íŒ¨ for", keyword, "â†’", targetName);
        }
      }
    }
    
    // 2ë‹¨ê³„: ê° ë‹¨ì–´ë³„ë¡œ ë§¤í•‘ í…Œì´ë¸” ê²€ì‚¬ (ì§ì ‘ ë§¤í•‘ì´ ì‹¤íŒ¨í•œ ê²½ìš°)
    if (!selectedMarket) {
      console.log("ğŸ” ë§¤í•‘ í…Œì´ë¸” ê²€ì‚¬ ì‹œì‘, ë¶„ì„í•  ë‹¨ì–´ë“¤:", words);
      
      for (let word of words) {
        console.log("ğŸ” ë‹¨ì–´ í™•ì¸:", word, "ë§¤í•‘ ì¡´ì¬:", !!marketMappings[word]);
        
        if (marketMappings[word]) {
          const targetMarketName = marketMappings[word];
          console.log("ğŸ“ ë§¤í•‘ ì°¾ìŒ:", word, "â†’", targetMarketName);
          
          // ë§¤í•‘ëœ ê³µíŒì¥ ì´ë¦„ìœ¼ë¡œ ì˜µì…˜ ì°¾ê¸° (ë” ì •í™•í•œ ë§¤ì¹­)
          const matchedOption = options.find(option => {
            if (!option.text || option.text === 'ê³µíŒì¥ì„ ì„ íƒí•˜ì„¸ìš”') return false;
            
            // ì •í™•í•œ ì´ë¦„ ë§¤ì¹­ ë˜ëŠ” í¬í•¨ ë§¤ì¹­
            return option.text === targetMarketName || 
                   option.text.includes(targetMarketName) ||
                   targetMarketName.includes(option.text);
          });
          
          console.log("ğŸª ì˜µì…˜ ê²€ìƒ‰ ê²°ê³¼:", matchedOption ? matchedOption.text : "ì—†ìŒ");
          
          if (matchedOption) {
            selectedMarket = matchedOption;
            console.log("âœ… ê³µíŒì¥ ë§¤í•‘ ì„±ê³µ:", word, "â†’", targetMarketName);
            break;
          } else {
            console.log("âŒ ì˜µì…˜ì—ì„œ ë§¤ì¹­ ì‹¤íŒ¨:", targetMarketName);
          }
        }
      }
    }
    
    // 3ë‹¨ê³„: ë§¤í•‘ìœ¼ë¡œ ì°¾ì§€ ëª»í•œ ê²½ìš° ê¸°ì¡´ ë°©ì‹ìœ¼ë¡œ ë¶€ë¶„ ì¼ì¹˜ ê²€ì‚¬
    if (!selectedMarket) {
      for (let option of options) {
        if (option.text && option.text !== 'ê³µíŒì¥ì„ ì„ íƒí•˜ì„¸ìš”') {
          // ì˜µì…˜ í…ìŠ¤íŠ¸ì˜ ê° ë‹¨ì–´ë¥¼ ê²€ì‚¬
          const optionWords = option.text.split(/\s+/);
          const foundMatch = optionWords.some(word => {
            // í•œ ê¸€ì ë‹¨ì–´ëŠ” ì œì™¸í•˜ê³  ë¶€ë¶„ ì¼ì¹˜ ê²€ì‚¬
            return word.length > 1 && transcript.includes(word);
          });
          
          if (foundMatch) {
            selectedMarket = option;
            console.log("ğŸª ê³µíŒì¥ ë¶€ë¶„ ì¼ì¹˜ ì„±ê³µ:", option.text);
            break;
          }
        }
      }
    }
    
    // ìµœì¢… ì„ íƒ ì ìš©
    if (selectedMarket) {
      marketField.value = selectedMarket.value;
      console.log("ğŸª ê³µíŒì¥ ì„¤ì • ì™„ë£Œ:", selectedMarket.text);
    } else {
      console.log("ğŸª ê³µíŒì¥ ë§¤ì¹­ ì‹¤íŒ¨: í•´ë‹¹í•˜ëŠ” ê³µíŒì¥ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ");
    }
  }
  
  console.log("âœ… í•„ë“œ ìë™ ì…ë ¥ ì™„ë£Œ");
}
</script>
