<div class="container mx-auto px-4 py-6">
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold text-gray-800">사과농장 물류 수거 관리</h1>
    <%= link_to "새 예약", new_collection_path, class: "bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded" %>
  </div>

  <!-- 필터 -->
  <div class="mb-4 bg-gray-50 p-4 rounded-lg">
    <%= form_with url: collections_path, method: :get, local: true, class: "space-y-4 md:space-y-0 md:flex md:items-end md:space-x-4" do |form| %>
      <div class="flex-1">
        <%= form.label :date, "날짜", class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= form.date_field :date, value: @date, class: "w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" %>
      </div>
      
      <div class="flex-1">
        <%= form.label :market_id, "공판장", class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= form.select :market_id, 
            grouped_options_for_select(@markets.group_by(&:district).transform_values { |markets| 
              markets.map { |m| [m.name, m.id] }
            }, params[:market_id]),
            { prompt: "전체 공판장" },
            { class: "w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" } %>
      </div>
      
      <div class="flex-1">
        <%= form.label :status, "상태", class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= form.select :status, 
            options_for_select([
              ["대기", "pending"],
              ["진행중", "in_progress"], 
              ["완료", "completed"]
            ], params[:status]),
            { prompt: "전체 상태" },
            { class: "w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" } %>
      </div>
      
      <div class="flex-1">
        <%= form.label :receiver, "담당자", class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= form.select :receiver, 
            options_for_select([["A", "A"], ["B", "B"]], params[:receiver]),
            { prompt: "전체 담당자" },
            { class: "w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" } %>
      </div>
      
      <div class="flex space-x-2">
        <%= form.submit "조회", class: "bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded" %>
        <%= link_to "초기화", collections_path, class: "bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded" %>
      </div>
    <% end %>
  </div>

  <!-- 요약 정보 -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
    <div class="bg-blue-100 p-4 rounded-lg">
      <h3 class="font-semibold text-blue-800">전체 물량</h3>
      <p class="text-2xl font-bold text-blue-600"><%= @summary[:total_quantity] %>박스</p>
    </div>
    <div class="bg-green-100 p-4 rounded-lg">
      <h3 class="font-semibold text-green-800">완료</h3>
      <p class="text-2xl font-bold text-green-600"><%= @summary[:completed_count] %>건</p>
    </div>
    <div class="bg-yellow-100 p-4 rounded-lg">
      <h3 class="font-semibold text-yellow-800">진행중</h3>
      <p class="text-2xl font-bold text-yellow-600"><%= @summary[:in_progress_count] %>건</p>
    </div>
    <div class="bg-red-100 p-4 rounded-lg">
      <h3 class="font-semibold text-red-800">대기</h3>
      <p class="text-2xl font-bold text-red-600"><%= @summary[:pending_count] %>건</p>
    </div>
  </div>

  <!-- 공판장별 물량 -->
  <div class="mb-6">
    <h2 class="text-lg font-semibold mb-3">공판장별 물량</h2>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <% @summary[:by_market].sort_by { |k, v| -v }.each do |market_id, quantity| %>
        <% market = @markets.find(market_id) %>
        <div class="bg-gray-50 p-3 rounded">
          <h4 class="font-medium"><%= market.name %></h4>
          <p class="text-lg font-bold text-gray-700"><%= quantity %>박스</p>
          <span class="text-xs text-gray-500"><%= market.district %></span>
        </div>
      <% end %>
    </div>
  </div>

  <!-- 수거 목록 -->
  <div class="bg-white shadow rounded-lg overflow-hidden">
    <!-- 데스크톱 테이블 -->
    <div class="hidden md:block">
      <table class="min-w-full">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">농장명</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">수량</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">공판장</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">담당자</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">예약일시</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">상태</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">액션</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          <% @collections.each do |collection| %>
            <tr>
              <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                <%= collection.farm_name %>
              </td>
              <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">
                <%= collection.quantity %>박스
              </td>
              <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">
                <%= collection.market.name %>
                <br><span class="text-xs text-gray-400"><%= collection.market.district %></span>
              </td>
              <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">
                <%= collection.receiver %>
              </td>
              <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">
                <%= collection.scheduled_at.strftime("%m/%d %H:%M") %>
              </td>
              <td class="px-4 py-4 whitespace-nowrap">
                <% case collection.status %>
                <% when 'pending' %>
                  <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">대기</span>
                <% when 'in_progress' %>
                  <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">진행중</span>
                <% when 'completed' %>
                  <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">완료</span>
                <% end %>
              </td>
              <td class="px-4 py-4 whitespace-nowrap text-sm font-medium">
                <div class="flex space-x-2">
                  <% if collection.pending? %>
                    <%= link_to "진행", update_status_collection_path(collection, status: 'in_progress'), 
                        method: :patch, class: "text-yellow-600 hover:text-yellow-900" %>
                  <% elsif collection.in_progress? %>
                    <%= link_to "완료", update_status_collection_path(collection, status: 'completed'), 
                        method: :patch, class: "text-green-600 hover:text-green-900" %>
                  <% end %>
                  <%= link_to "수정", edit_collection_path(collection), class: "text-indigo-600 hover:text-indigo-900" %>
                  <%= link_to "삭제", collection_path(collection), method: :delete, 
                      confirm: "정말 삭제하시겠습니까?", class: "text-red-600 hover:text-red-900" %>
                </div>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>

    <!-- 모바일 카드 뷰 -->
    <div class="md:hidden">
      <% @collections.each do |collection| %>
        <div class="border-b border-gray-200 p-4">
          <div class="flex justify-between items-start mb-2">
            <h3 class="text-lg font-medium text-gray-900"><%= collection.farm_name %></h3>
            <% case collection.status %>
            <% when 'pending' %>
              <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">대기</span>
            <% when 'in_progress' %>
              <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">진행중</span>
            <% when 'completed' %>
              <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">완료</span>
            <% end %>
          </div>
          
          <div class="text-sm text-gray-500 space-y-1 mb-3">
            <div><span class="font-medium">수량:</span> <%= collection.quantity %>박스</div>
            <div><span class="font-medium">공판장:</span> <%= collection.market.name %> (<%= collection.market.district %>)</div>
            <div><span class="font-medium">담당자:</span> <%= collection.receiver %></div>
            <div><span class="font-medium">예약일시:</span> <%= collection.scheduled_at.strftime("%m/%d %H:%M") %></div>
          </div>
          
          <div class="flex flex-wrap gap-2">
            <% if collection.pending? %>
              <%= link_to "진행", update_status_collection_path(collection, status: 'in_progress'), 
                  method: :patch, class: "bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-sm font-medium" %>
            <% elsif collection.in_progress? %>
              <%= link_to "완료", update_status_collection_path(collection, status: 'completed'), 
                  method: :patch, class: "bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-medium" %>
            <% end %>
            <%= link_to "수정", edit_collection_path(collection), class: "bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium" %>
            <%= link_to "삭제", collection_path(collection), method: :delete, 
                confirm: "정말 삭제하시겠습니까?", class: "bg-red-100 text-red-800 px-3 py-1 rounded-full text-sm font-medium" %>
          </div>
        </div>
      <% end %>
    </div>
    
    <% if @collections.empty? %>
      <div class="text-center py-8 text-gray-500">
        선택한 날짜에 수거 예약이 없습니다.
      </div>
    <% end %>
  </div>
</div>
